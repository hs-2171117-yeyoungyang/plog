import React, {useState, useEffect, useRef, useCallback} from "react";
import {useLocation, useNavigate} from "react-router-dom";
import {InputField} from "../../components/Input";
import {Button} from "../../components/Button/Button";
import Header from "../../components/Header/Header";
import styles from "./ProjectDetail.module.css";
import {MoreHorizontal, Play, Plus, Save, ChevronLeft, ChevronRight} from "lucide-react";
import UrlModal from "../../components/UrlModal/UrlModal";
import ActionMenu from "../../components/ActionMenu/ActionMenu";
import ApiGroupCard from "../../components/ApiGroupCard/ApiGroupCard";
import ApiTestConfigCard, {type ApiTestConfig} from "../../components/ApiTestConfigCard/ApiTestConfigCard";
import type {OpenApiSpec} from "../../assets/mockProjectData";
import {deleteProject, getProjectDetail} from "../../api";
import {generateLoadTestScript, type LoadTestingRequest} from "../../api/loadTesting";
import ApiTree from "../../components/ApiTree/ApiTree";
import WarningModal from "../../components/WarningModal/WarningModal";

interface ProjectData {
  id: number;
  title: string;
  summary: string;
  description: string;
}

interface ApiServer {
  id: string;
  name: string;
  groups: {
    id: string;
    name: string;
    endpoints: {
      id: string;
      path: string;
      method: "GET" | "POST" | "PUT" | "DELETE" | "PATCH";
    }[];
  }[];
}

const ProjectDetail: React.FC = () => {
  const navigate = useNavigate();
  const location = useLocation();
  const projectId = location.state?.projectId;
  const [projectData, setProjectData] = useState<ProjectData | null>(null);
  const [openApiSpecs, setOpenApiSpecs] = useState<OpenApiSpec[]>([]);
  const [scenarioTitle, setScenarioTitle] = useState("");
  const [scenarioDescription, setScenarioDescription] = useState("");
  const [targetTps, setTargetTps] = useState("");
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [menuOpen, setMenuOpen] = useState(false);
  const [apiTestConfigs, setApiTestConfigs] = useState<ApiTestConfig[]>([]);
  const [isWarningModalOpen, setIsWarningModalOpen] = useState(false);
  const [isSubmitting, setIsSubmitting] = useState(false);

  // Î¶¨ÏÇ¨Ïù¥Ï¶à Í¥ÄÎ†® ÏÉÅÌÉú
  const [leftWidth, setLeftWidth] = useState(20.1); // %
  const [rightWidth, setRightWidth] = useState(25.8); // %
  const [isLeftCollapsed, setIsLeftCollapsed] = useState(false);
  const [isRightCollapsed, setIsRightCollapsed] = useState(false);
  const [isLeftResizing, setIsLeftResizing] = useState(false);
  const [isRightResizing, setIsRightResizing] = useState(false);

  const containerRef = useRef<HTMLDivElement>(null);

  // ÏµúÏÜå/ÏµúÎåÄ ÎÑàÎπÑ ÏÑ§Ï†ï (%)
  const MIN_PANEL_WIDTH = 15;
  const MAX_PANEL_WIDTH = 40;
  const COLLAPSE_THRESHOLD = 12; // Ïù¥ ÎÑàÎπÑ Ïù¥ÌïòÎ°ú Ï§ÑÏñ¥Îì§Î©¥ ÏûêÎèôÏúºÎ°ú Ï†ëÌûò

  useEffect(() => {
    if (!projectId) {
      navigate("/");
      return;
    }

    getProjectDetail(projectId)
      .then((res) => {
        const data = res.data.data;
        setProjectData({
          id: data.id,
          title: data.title,
          summary: data.summary,
          description: data.description,
        });
        setOpenApiSpecs(data.openapi_specs);
        console.log("üì© ÌîÑÎ°úÏ†ùÌä∏ ÏÉÅÏÑ∏ Ï†ïÎ≥¥: ", data);
      })
      .catch((err) => {
        console.error("‚ùå ÌîÑÎ°úÏ†ùÌä∏ ÏÉÅÏÑ∏ Î∂àÎü¨Ïò§Í∏∞ Ïã§Ìå®:", err);
        navigate("/");
      });
  }, [projectId, navigate]);

  // Î¶¨ÏÇ¨Ïù¥Ï¶à Ìï∏Îì§Îü¨
  const handleMouseDown = useCallback((side: 'left' | 'right') => (e: React.MouseEvent) => {
    e.preventDefault();
    if (side === 'left') {
      setIsLeftResizing(true);
    } else {
      setIsRightResizing(true);
    }
  }, []);

  const handleMouseMove = useCallback((e: MouseEvent) => {
    if (!containerRef.current) return;

    const containerRect = containerRef.current.getBoundingClientRect();
    const containerWidth = containerRect.width;
    const mouseX = e.clientX - containerRect.left;

    if (isLeftResizing) {
      const newLeftWidth = (mouseX / containerWidth) * 100;
      
      if (newLeftWidth < COLLAPSE_THRESHOLD) {
        setIsLeftCollapsed(true);
        setLeftWidth(MIN_PANEL_WIDTH);
      } else if (newLeftWidth >= MIN_PANEL_WIDTH && newLeftWidth <= MAX_PANEL_WIDTH) {
        setLeftWidth(newLeftWidth);
        setIsLeftCollapsed(false);
      }
    }

    if (isRightResizing) {
      const newRightWidth = ((containerWidth - mouseX) / containerWidth) * 100;
      
      if (newRightWidth < COLLAPSE_THRESHOLD) {
        setIsRightCollapsed(true);
        setRightWidth(MIN_PANEL_WIDTH);
      } else if (newRightWidth >= MIN_PANEL_WIDTH && newRightWidth <= MAX_PANEL_WIDTH) {
        setRightWidth(newRightWidth);
        setIsRightCollapsed(false);
      }
    }
  }, [isLeftResizing, isRightResizing]);

  const handleMouseUp = useCallback(() => {
    setIsLeftResizing(false);
    setIsRightResizing(false);
  }, []);

  useEffect(() => {
    if (isLeftResizing || isRightResizing) {
      document.addEventListener('mousemove', handleMouseMove);
      document.addEventListener('mouseup', handleMouseUp);
      document.body.style.cursor = 'col-resize';
      document.body.style.userSelect = 'none';

      return () => {
        document.removeEventListener('mousemove', handleMouseMove);
        document.removeEventListener('mouseup', handleMouseUp);
        document.body.style.cursor = '';
        document.body.style.userSelect = '';
      };
    }
  }, [isLeftResizing, isRightResizing, handleMouseMove, handleMouseUp]);

  // Ìå®ÎÑê ÌÜ†Í∏Ä Ìï®Ïàò
  const toggleLeftPanel = () => {
    setIsLeftCollapsed(!isLeftCollapsed);
  };

  const toggleRightPanel = () => {
    setIsRightCollapsed(!isRightCollapsed);
  };

  const convertToApiTreeData = (specs: OpenApiSpec[]): ApiServer[] => {
    return specs.map((spec) => ({
      id: spec.id.toString(),
      name: spec.title,
      groups: spec.tags.map((tag) => ({
        id: tag.id.toString(),
        name: tag.name,
        endpoints: tag.endpoints.map((endpoint) => ({
          id: endpoint.id.toString(),
          path: endpoint.path,
          method: endpoint.method,
        })),
      })),
    }));
  };

  const refreshProjectData = async () => {
    try {
      const res = await getProjectDetail(projectId);
      const data = res.data.data;
      setProjectData({
        id: data.id,
        title: data.title,
        summary: data.summary,
        description: data.description,
      });
      setOpenApiSpecs(data.openapi_specs);
      console.log("‚úÖ ÌîÑÎ°úÏ†ùÌä∏ Îç∞Ïù¥ÌÑ∞ ÏÉàÎ°úÍ≥†Ïπ® ÏôÑÎ£å");
    } catch (err) {
      console.error("‚ùå ÌîÑÎ°úÏ†ùÌä∏ Îç∞Ïù¥ÌÑ∞ ÏÉàÎ°úÍ≥†Ïπ® Ïã§Ìå®:", err);
    }
  };

  // endpoint_idÎ•º Ï∞æÎäî Ìó¨Ìçº Ìï®Ïàò
  const findEndpointId = (path: string): number | null => {
    for (const spec of openApiSpecs) {
      for (const tag of spec.tags) {
        for (const endpoint of tag.endpoints) {
          if (endpoint.path === path) {
            return endpoint.id;
          }
        }
      }
    }
    return null;
  };

  const handleEndpointClick = (
    endpoint: {id: string; path: string; method: string},
    serverName: string,
    groupName: string
  ) => {
    console.log(`ÏÑ†ÌÉùÎêú ÏóîÎìúÌè¨Ïù∏Ìä∏:`, {
      server: serverName,
      group: groupName,
      path: endpoint.path,
      method: endpoint.method,
    });

    const endpointId = findEndpointId(endpoint.path);
    if (!endpointId) {
      console.error("ÏóîÎìúÌè¨Ïù∏Ìä∏ IDÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§:", endpoint.path);
      return;
    }

    const newConfig: ApiTestConfig = {
      id: Date.now().toString(),
      endpoint_id: endpointId,
      endpoint_path: endpoint.path,
      scenario_name: `${groupName}_${endpoint.method}_${endpoint.path.split('/').pop()}`,
      think_time: 1,
      executor: 'constant-vus',
      stages: [{ duration: '10s', target: 10 }],
    };
    setApiTestConfigs((prev) => [...prev, newConfig]);
  };

  const handleAddApiTest = (endpoint: string) => {
    const endpointId = findEndpointId(endpoint);
    if (!endpointId) {
      console.error("ÏóîÎìúÌè¨Ïù∏Ìä∏ IDÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§:", endpoint);
      return;
    }

    const newConfig: ApiTestConfig = {
      id: Date.now().toString(),
      endpoint_id: endpointId,
      endpoint_path: endpoint,
      scenario_name: `scenario_${Date.now()}`,
      think_time: 1,
      executor: 'constant-vus',
      stages: [{ duration: '10s', target: 10 }],
    };
    setApiTestConfigs((prev) => [...prev, newConfig]);
  };

  const handleRemoveApiTest = (id: string) => {
    setApiTestConfigs((prev) => prev.filter((config) => config.id !== id));
  };

  const handleConfigChange = (updatedConfig: ApiTestConfig) => {
    setApiTestConfigs((prev) => 
      prev.map((config) => 
        config.id === updatedConfig.id ? updatedConfig : config
      )
    );
  };

  // Î°úÎìú ÌÖåÏä§ÌåÖ Ïã§Ìñâ
  const handleRunLoadTest = async () => {
    if (apiTestConfigs.length === 0) {
      alert("ÏµúÏÜå 1Í∞ú Ïù¥ÏÉÅÏùò API ÌÖåÏä§Ìä∏Î•º Íµ¨ÏÑ±Ìï¥Ï£ºÏÑ∏Ïöî.");
      return;
    }

    if (!scenarioTitle.trim()) {
      alert("ÌÖåÏä§Ìä∏ ÏãúÎÇòÎ¶¨Ïò§ Ï†úÎ™©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.");
      return;
    }

    setIsSubmitting(true);

    try {
      const loadTestRequest: LoadTestingRequest = {
        title: scenarioTitle,
        description: scenarioDescription || "ÏÑ§Î™Ö ÏóÜÏùå",
        target_tps: targetTps ? parseFloat(targetTps) : undefined,
        scenarios: apiTestConfigs.map((config) => ({
          name: config.scenario_name,
          endpoint_id: config.endpoint_id,
          executor: config.executor,
          think_time: config.think_time,
          stages: config.stages,
          response_time_target: config.response_time_target,
          error_rate_target: config.error_rate_target,
        })),
      };

      console.log("üöÄ Î°úÎìú ÌÖåÏä§Ìä∏ ÏöîÏ≤≠:", loadTestRequest);

      const response = await generateLoadTestScript(loadTestRequest);
      console.log("‚úÖ Î°úÎìú ÌÖåÏä§Ìä∏ ÏãúÏûë:", response.data);

      // ÌÖåÏä§Ìä∏ ÌéòÏù¥ÏßÄÎ°ú Ïù¥ÎèôÌïòÎ©¥ÏÑú job_nameÏùÑ Ï†ÑÎã¨
      navigate("/test", { 
        state: { 
          jobName: response.data.job_name,
          fileName: response.data.file_name,
          testTitle: scenarioTitle
        } 
      });
    } catch (error) {
      console.error("‚ùå Î°úÎìú ÌÖåÏä§Ìä∏ ÏãúÏûë Ïã§Ìå®:", error);
      alert("Î°úÎìú ÌÖåÏä§Ìä∏ ÏãúÏûëÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.");
    } finally {
      setIsSubmitting(false);
    }
  };

  if (!projectData) {
    return (
      <div className={styles.container}>
        <Header />
        <div className={styles.mainContent}>
          <div style={{padding: "20px", textAlign: "center"}}>
            ÌîÑÎ°úÏ†ùÌä∏Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...
          </div>
        </div>
      </div>
    );
  }

  // Ï§ëÏïô ÏòÅÏó≠Ïùò ÎÑàÎπÑ Í≥ÑÏÇ∞
  const centerWidth = 100 - (isLeftCollapsed ? 0 : leftWidth) - (isRightCollapsed ? 0 : rightWidth);

  return (
    <div className={styles.container}>
      {isModalOpen && (
        <UrlModal
          onClose={() => setIsModalOpen(false)}
          projectId={projectData.id}
          onSuccess={refreshProjectData}
        />
      )}
      <Header />
      <div className={styles.mainContent} ref={containerRef}>
        {/* ÏôºÏ™Ω ÏòÅÏó≠ */}
        <div 
          className={`${styles.leftSection} ${isLeftCollapsed ? styles.collapsed : ''}`}
          style={{
            width: isLeftCollapsed ? '0px' : `${leftWidth}%`,
            minWidth: isLeftCollapsed ? '0px' : `${leftWidth}%`,
            maxWidth: isLeftCollapsed ? '0px' : `${leftWidth}%`,
          }}
        >
          <div className={styles.scrollArea}>
            {openApiSpecs.length > 0 ? (
              <ApiTree
                servers={convertToApiTreeData(openApiSpecs)}
                onEndpointClick={handleEndpointClick}
              />
            ) : (
              <div className={styles.noApiData}>
                <p>Îì±Î°ùÎêú APIÍ∞Ä ÏóÜÏäµÎãàÎã§.</p>
                <p>API ÏÑúÎ≤ÑÎ•º Îì±Î°ùÌï¥Ï£ºÏÑ∏Ïöî.</p>
              </div>
            )}
          </div>
          <div className={styles.buttonContainer}>
            <Button
              variant="secondary"
              icon={<Plus />}
              onClick={() => setIsModalOpen(true)}>
              API ÏÑúÎ≤Ñ Îì±Î°ù
            </Button>
          </div>
        </div>

        {/* ÏôºÏ™Ω Î¶¨ÏÇ¨Ïù¥Ï†Ä */}
        {!isLeftCollapsed && (
          <div 
            className={`${styles.resizer} ${isLeftResizing ? styles.active : ''}`}
            onMouseDown={handleMouseDown('left')}
          />
        )}

        {/* Ï†ëÌûå ÏôºÏ™Ω Ìå®ÎÑê ÌÜ†Í∏Ä Î≤ÑÌäº */}
        {isLeftCollapsed && (
          <button 
            className={`${styles.collapsedToggle} ${styles.leftCollapsedToggle}`}
            onClick={toggleLeftPanel}
            type="button"
          >
            <ChevronRight />
          </button>
        )}

        {/* Í∞ÄÏö¥Îç∞ ÏòÅÏó≠ */}
        <div 
          className={styles.centerSection}
          style={{ width: `${centerWidth}%` }}
        >
          <div className={styles.scrollArea}>
            <div className={styles.projectInfo}>
              <div className={styles.projectHeader}>
                <div className={styles.projectTitle}>
                  <div className="HeadingS">{projectData.title}</div>
                  <button
                    className={styles.menuButton}
                    onClick={(e) => {
                      e.stopPropagation();
                      setMenuOpen(!menuOpen);
                    }}
                    aria-label="ÌîÑÎ°úÏ†ùÌä∏ Î©îÎâ¥"
                    type="button">
                    <MoreHorizontal />
                  </button>
                  {isWarningModalOpen && (
                    <WarningModal
                      projectId={projectData.id}
                      onClose={() => setIsWarningModalOpen(false)}
                      onSuccess={async () => {
                        await deleteProject(projectData.id);
                        console.log("‚úÖ ÏÇ≠Ï†ú ÏôÑÎ£å");
                        navigate("/");
                      }}
                    />
                  )}
                  {menuOpen && (
                    <ActionMenu
                      projectId={projectData.id}
                      onEdit={() => setMenuOpen(false)}
                      onDelete={() => {
                        setMenuOpen(false);
                        setIsWarningModalOpen(true);
                      }}
                      onClose={() => setMenuOpen(false)}
                    />
                  )}
                </div>
                <div className={`Body ${styles.projectSubtitle}`}>
                  {projectData.summary}
                </div>
              </div>
              <div className={`CaptionLight ${styles.projectDescription}`}>
                {projectData.description}
              </div>
            </div>

            <div className={styles.divider}></div>

            <div className={styles.apiGroupsSection}>
              {openApiSpecs.length > 0 ? (
                openApiSpecs.flatMap((spec) =>
                  spec.tags.map((tag) => (
                    <ApiGroupCard
                      key={`${spec.id}-${tag.id}`}
                      groupName={tag.name}
                      baseUrl={spec.base_url}
                      endpoints={tag.endpoints}
                      onAddEndpoint={handleAddApiTest}
                    />
                  ))
                )
              ) : (
                <div className={styles.noApiGroups}>
                  <p>Îì±Î°ùÎêú API Í∑∏Î£πÏù¥ ÏóÜÏäµÎãàÎã§.</p>
                  <p>
                    ÏÉÅÎã®Ïùò "API ÏÑúÎ≤Ñ Îì±Î°ù" Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠ÌïòÏó¨ APIÎ•º Ï∂îÍ∞ÄÌï¥Î≥¥ÏÑ∏Ïöî.
                  </p>
                </div>
              )}
            </div>
          </div>
        </div>

        {/* Ï†ëÌûå Ïò§Î•∏Ï™Ω Ìå®ÎÑê ÌÜ†Í∏Ä Î≤ÑÌäº */}
        {isRightCollapsed && (
          <button 
            className={`${styles.collapsedToggle} ${styles.rightCollapsedToggle}`}
            onClick={toggleRightPanel}
            type="button"
          >
            <ChevronLeft />
          </button>
        )}

        {/* Ïò§Î•∏Ï™Ω Î¶¨ÏÇ¨Ïù¥Ï†Ä */}
        {!isRightCollapsed && (
          <div 
            className={`${styles.resizer} ${isRightResizing ? styles.active : ''}`}
            onMouseDown={handleMouseDown('right')}
          />
        )}

        {/* Ïò§Î•∏Ï™Ω ÏòÅÏó≠ */}
        <div 
          className={`${styles.rightSection} ${isRightCollapsed ? styles.collapsed : ''}`}
          style={{
            width: isRightCollapsed ? '0px' : `${rightWidth}%`,
            minWidth: isRightCollapsed ? '0px' : `${rightWidth}%`,
            maxWidth: isRightCollapsed ? '0px' : `${rightWidth}%`,
          }}
        >
          <div className={styles.formArea}>
            <div className={styles.inputContainer}>
              <InputField
                title="ÌÖåÏä§Ìä∏ ÏãúÎÇòÎ¶¨Ïò§ Ï†úÎ™©"
                placeholder="ÏãúÎÇòÎ¶¨Ïò§ Ï†úÎ™©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî."
                value={scenarioTitle}
                onChange={setScenarioTitle}
              />
              <InputField
                title="ÌÖåÏä§Ìä∏ ÏãúÎÇòÎ¶¨Ïò§ ÏÉÅÏÑ∏ ÎÇ¥Ïö©"
                placeholder="ÌÖåÏä§Ìä∏ ÎåÄÏÉÅ, API, Î∞©Ïãù, Î™©Ï†Å Îì±ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî."
                value={scenarioDescription}
                onChange={setScenarioDescription}
              />
              <InputField
                title="Î™©Ìëú TPS (ÏÑ†ÌÉùÏÇ¨Ìï≠)"
                placeholder="Ïòà: 1000"
                value={targetTps}
                onChange={setTargetTps}
              />

              {apiTestConfigs.map((config) => (
                <ApiTestConfigCard
                  key={config.id}
                  config={config}
                  onRemove={() => handleRemoveApiTest(config.id)}
                  onChange={handleConfigChange}
                />
              ))}
            </div>
          </div>
          <div className={styles.buttonGroup}>
            <Button variant="secondary" icon={<Save />}>
              ÏûÑÏãú Ï†ÄÏû•
            </Button>
            <Button
              variant="primaryGradient"
              icon={<Play />}
              onClick={handleRunLoadTest}
              disabled={isSubmitting || apiTestConfigs.length === 0}>
              {isSubmitting ? "ÌÖåÏä§Ìä∏ ÏãúÏûë Ï§ë..." : "ÌÖåÏä§Ìä∏ Ïã§ÌñâÌïòÍ∏∞"}
            </Button>
          </div>
        </div>
      </div>
    </div>
  );
};

export default ProjectDetail;